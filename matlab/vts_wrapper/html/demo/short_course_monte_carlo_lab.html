
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Monte Carlo Laboratory B,</title><meta name="generator" content="MATLAB 9.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2023-01-10"><meta name="DC.source" content="short_course_monte_carlo_lab.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Monte Carlo Laboratory B,</h1><!--introduction--><p>Script for short course laboratory</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">Example 1a: run Monte Carlo simulations for fluence with increasing N photons</a></li><li><a href="#3">Example 1b: Compare standard deviation of two absorption methods</a></li><li><a href="#4">Example 2: run Monte Carlo simulations accounting for absorption with</a></li></ul></div><h2 id="2">Example 1a: run Monte Carlo simulations for fluence with increasing N photons</h2><pre class="codeoutput">Running simulations...
Simulations complete! Run time: 4.3967 seconds
</pre><img vspace="5" hspace="5" src="short_course_monte_carlo_lab_01.png" alt=""> <img vspace="5" hspace="5" src="short_course_monte_carlo_lab_02.png" alt=""> <img vspace="5" hspace="5" src="short_course_monte_carlo_lab_03.png" alt=""> <h2 id="3">Example 1b: Compare standard deviation of two absorption methods</h2><p>this cell relies on above cell execution</p><img vspace="5" hspace="5" src="short_course_monte_carlo_lab_04.png" alt=""> <h2 id="4">Example 2: run Monte Carlo simulations accounting for absorption with</h2><p>analog and continuous absorption weighting with 10,000 photons and compare time and relative error</p><pre class="codeoutput">Analog results:
Running simulation...
Simulation complete! Run time: 0.34484 seconds
Continuous absorption weighting results:
Running simulation...
Simulation complete! Run time: 39.9985 seconds
</pre><img vspace="5" hspace="5" src="short_course_monte_carlo_lab_05.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Monte Carlo Laboratory B, 
% Script for short course laboratory
%%
clear
clc

startup();

% ======================================================================= %
%% Example 1a: run Monte Carlo simulations for fluence with increasing N photons
clear;
Nphot=[10, 100, 1000, 10000]; % number of photons launched takes about 1 mins

% simulation options initiation
options = SimulationOptions();
% set method to account for absorption
options.AbsorptionWeightingType = 'Analog'; % options 'Analog' or 'Discrete'
% seed of random number generator (-1=randomly selected seed, >=0 reproducible sequence)
options.Seed = 0;

% create a point source directed perpendicularly into the tissue 
sourceInput = DirectionalPointSourceInput();
% Point source type 
sourceInput.SourceType = 'DirectionalPoint';
% New position 
sourceInput.PointLocation = [0 0 0];    
% Point source emitting direction
sourceInput.Direction = [0 0 1];  
% Initial tissue region index        
sourceInput.InitialTissueRegionIndex = 0; 

% create a single layer tissue of thickness 100mm 
tissueInput = MultiLayerTissueInput();

% assign the tissue layer regions struct
tissueInput.LayerRegions = struct(...
    'ZRange', ...
    {...
        [-Inf, 0], ... % air "z" range
        [0, 100], ... % tissue "z" range
        [100, +Inf] ... % air "z" range
    }, ...
    'RegionOP', ...
    {...
        [0.0, 1e-10, 1.0, 1.0], ... % air optical properties
        [0.01, 1.0, 0.8, 1.4], ... % tissue OPs [ua, us', g, n]
        [0.0, 1e-10, 1.0, 1.0] ... % air optical properties
    } ...
);
 
% (rho,z) cylindrical coordinates grid definition in units mm
% define endpoints of rho and z tally bins and midpoints for plotting purposes
rhos = linspace(0,10,101);
rho_midpoints = (rhos(1:end-1)+rhos(2:end))/2;
zs = linspace(0,10,101);
z_midpoints = (zs(1:end-1)+zs(2:end))/2;

% create simulation inputs for increasing N
for i=1:size(Nphot,2)
  % create a default set of inputs
  si(i) = SimulationInput();
  si(i).Options = options;
  % modify number of photons
  si(i).N = Nphot(i);
  si(i).TissueInput = tissueInput;
  % specify Fluence(rho,z) detector by the endpoints of rho and z bins
  si(i).DetectorInputs = { DetectorInput.FluenceOfRhoAndZ(rhos,zs) };
  % calculate the 2nd moment of the estimates so that variance can be calculated
  si(i).DetectorInputs{1}.TallySecondMoment = true;
end
% run all simulations
output = VtsMonteCarlo.RunSimulations(si);

% plot out results of each simulation 
scrsz=get(0,'ScreenSize');
f=figure('Position',[scrsz(3)/50 scrsz(4)/10 scrsz(3)/2 scrsz(4)/2]);
set(f,'Name',sprintf('Fluence using %s absorption',options.AbsorptionWeightingType));
% spell out left and bottom corners of each plot to reduce white space
left=[0.09 0.59 0.09 0.59];bottom=[0.58 0.58 0.1 0.1];
xs = [-fliplr(rho_midpoints),rho_midpoints];
for j=1:size(Nphot,2)
  d = output{j}.Detectors(output{j}.DetectorNames{1});
  % plot fluence as a function of rho and z with mirror image
  %subplot(2,2,j,'Position',[left(j) bottom(j) 0.4 0.4]); % 2014b code
  pos=[left(j) bottom(j) 0.38 0.38]; % 2016b fix
  ax(j)=subplot(2,2,j); % 2016b fix
  set(ax(j),'Position',pos); % 2016b fix
  imagesc(xs,z_midpoints,log10([fliplr(d.Mean') d.Mean']));
  colormap(parula);
  colorbar; caxis([-6 1]); 
  shading('flat'); axis equal; axis([-9.5 9.5, 0 9.5]); 
  text(-8.5, 8, sprintf('N=%d',floor(Nphot(j))),'FontSize',16,'Color',[1 1 1]);
  title('log(Flu(\rho,z)) [mm^-^2]','FontSize',16); 
  xlabel('\rho [mm]','FontSize',16); ylabel('z [mm]','FontSize',16); 
end
f=figure('Position',[scrsz(3)/2 scrsz(4)/10 scrsz(3)/2 scrsz(4)/2]);
set(f,'Name',sprintf('Relative error using %s absorption',options.AbsorptionWeightingType));
for j=1:size(Nphot,2)
  d = output{j}.Detectors(output{j}.DetectorNames{1});
  % omit last bin since contains tallies for everything beyond last bin
  Mean = d.Mean(1:end-1,1:end-1);
  SecondMoment = d.SecondMoment(1:end-1,1:end-1);
  % determine standard deviation of the results
  SD = sqrt((SecondMoment - (Mean .* Mean)) / Nphot(j));
  relErr = SD./Mean;
  % set NaN to value beyond max
  maxval = max(relErr(:));
  relErr(isnan(relErr)) = maxval + maxval/10;
  %subplot(2,2,j,'Position',[left(j) bottom(j) 0.4 0.4]);  % 2014b code
  pos=[left(j) bottom(j) 0.38 0.38]; % 2016b fix
  ax(j)=subplot(2,2,j); % 2016b fix
  set(ax(j),'Position',pos); % 2016b fix
  imagesc(xs(1:end-2),z_midpoints(1:end-1),([fliplr(relErr') relErr'])); colormap(jet);
  % for making NaN values white
  colordata = colormap;
  colordata(end,:) = [0 0 0];
  colormap((colordata));
  colorbar;
  caxis([0 1]);
  shading('flat'); axis equal;axis([-9.5 9.5, 0 9.5]);
  text(-8.5, 8, sprintf('N=%d',floor(Nphot(j))),'FontSize',16,'Color',[1 1 0]);
  title('relerr(Flu(\rho,z))', 'FontSize',16); 
  xlabel('\rho [mm]','FontSize',16); ylabel('z [mm]','FontSize',16);
  if (strcmp(options.AbsorptionWeightingType,'Analog')==true)
    save(sprintf('analogMean%d.txt',j),'-ascii','Mean');
    save(sprintf('analogSD%d.txt',j),'-ascii','SD');
  elseif (strcmp(options.AbsorptionWeightingType,'Discrete')==true)
    save(sprintf('dawMean%d.txt',j),'-ascii','Mean');
    save(sprintf('dawSD%d.txt',j),'-ascii','SD');
  end
end
%% Example 1b: Compare standard deviation of two absorption methods
% this cell relies on above cell execution
f=figure('Position',[scrsz(3)/5 scrsz(4)/5 scrsz(3)/2 scrsz(4)/2]);
set(f,'Name','Analog relative error - DAW relative error');
for j=1:size(Nphot,2)
  analogSD = load(sprintf('analogSD%d.txt',j));
  analogMean = load(sprintf('analogMean%d.txt',j));
  dawSD = load(sprintf('dawSD%d.txt',j));
  dawMean = load(sprintf('dawMean%d.txt',j));
  analogRelErr = analogSD./analogMean;
  dawRelErr = dawSD./dawMean;
  %subplot(2,2,j,'Position',[left(j) bottom(j) 0.4 0.4]); 
  pos=[left(j) bottom(j) 0.38 0.38]; % 2016b fix
  ax(j)=subplot(2,2,j); % 2016b fix
  set(ax(j),'Position',pos); % 2016b fix
  imagesc(xs,z_midpoints,([fliplr((analogRelErr-dawRelErr)') (analogRelErr-dawRelErr)'])); 
  colordata = colormap(jet);
  colordata(1,:) = [0 0 0];
  colormap((colordata));
  colorbar; caxis([0 1]);
  shading('flat'); axis equal;axis([-9.5 9.5, 0 9.5]);
  text(-8.5, 8, sprintf('N=%d',floor(Nphot(j))),'FontSize',16,'Color',[1 1 1]);
  title('RE(analog)-RE(DAW)','FontSize',16); 
  xlabel('\rho [mm]','FontSize',16); ylabel('z [mm]','FontSize',16);
end

% ======================================================================= %
%% Example 2: run Monte Carlo simulations accounting for absorption with
% analog and continuous absorption weighting with 10,000 photons and compare
% time and relative error

% create a default set of inputs
si = SimulationInput();
si.N = 10000;
% simulation options initiation
options = SimulationOptions(); 
% seed of random number generator (-1=randomly selected seed, >=0 reproducible sequence)
options.Seed = 0;
si.Options = options;

% create a new 'instance' of the MultiLayerTissueInput class
tissueInput = MultiLayerTissueInput();
% assign the tissue layer regions struct
tissueInput.LayerRegions = struct(...
    'ZRange', ...
    {...
        [-Inf, 0], ... % air "z" range
        [0, 100], ... % tissue "z" range
        [100, +Inf] ... % air "z" range
    }, ...
    'RegionOP', ...
    {...
        [0.0, 1e-10, 1.0, 1.0], ... % air optical properties
        [0.1, 1, 0.8, 1.4], ... % tissue OPs [ua, us', g, n]
        [0.0, 1e-10, 1.0, 1.0] ... % air optical properties
    } ...
);
si.TissueInput = tissueInput;

% specify a single R(rho) detector by the endpoints of rho bins
si.DetectorInputs = { DetectorInput.ROfRho(linspace(0,10,101)) };
si.DetectorInputs{1}.TallySecondMoment = true;

% specify analog absorption and run simulation
si.Options.AbsorptionWeightingType = 'Analog';
disp('Analog results:');
output1 = VtsMonteCarlo.RunSimulation(si);

% specify continuous absorption weighting (CAW) and run simulation
si.Options.AbsorptionWeightingType = 'Continuous';
disp('Continuous absorption weighting results:');
output2 = VtsMonteCarlo.RunSimulation(si);

d1 = output1.Detectors(output1.DetectorNames{1});
d2 = output2.Detectors(output2.DetectorNames{1});
% determine standard deviation using 1st and 2nd moment results
d1SD = sqrt((d1.SecondMoment - (d1.Mean .* d1.Mean)) / si.N);
d2SD = sqrt((d2.SecondMoment - (d2.Mean .* d2.Mean)) / si.N);
% plot R(rho) using both methods with errorbars
f=figure; 
set(f,'Name','Spatially-resolved reflectance with 1-sigma error bars');
subplot(2,1,1);
errorbar(d1.Rho, d1.Mean, d1SD,'r-');
hold on;
errorbar(d2.Rho, d2.Mean, d2SD,'b-');
set(gca,'YScale','log');
axis([0 9.9, 1e-6 1]);
title('log(R(\rho)) [mm^-^2]'); %xlabel('Rho (mm)');
l=legend('analog','CAW');
set(l,'FontSize',10);

% plot analog relative error - CAW relative error
subplot(2,1,2);
plot(d1.Rho, (d1SD./d1.Mean-d2SD./d2.Mean),'g-',d1.Rho,zeros(length(d1.Rho),1),'k:');
%axis([0 9.9, -0.1 0.1]);
title('analog relative error - CAW relative error'); xlabel('Rho (mm)');
##### SOURCE END #####
--></body></html>