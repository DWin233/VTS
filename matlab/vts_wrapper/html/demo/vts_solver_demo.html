
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Solver Demos</title><meta name="generator" content="MATLAB 9.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2023-01-10"><meta name="DC.source" content="vts_solver_demo.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Solver Demos</h1><!--introduction--><p>Script for demoing the use of the VTS solvers within Matlab, to view the source code open the <b>vts_solver_demo.m</b> script file.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">Example ROfRhoAndFt</a></li><li><a href="#3">Example ROfFxAndFt</a></li><li><a href="#4">Example FluenceOfRhoAndZ</a></li><li><a href="#5">Example FluenceOfRhoAndZAndFt</a></li><li><a href="#6">Example PHDOfRhoAndZ</a></li><li><a href="#7">Example FluenceOfRhoAndZTwoLayer</a></li><li><a href="#8">Example PHDOfRhoAndZTwoLayer</a></li><li><a href="#9">Example AbsorbedEnergyOfRhoAndZ</a></li><li><a href="#10">Example ROfRho</a></li><li><a href="#11">Example ROfRhoAndT</a></li><li><a href="#12">Example ROfFxAndT</a></li><li><a href="#13">Example ROfFx (single set of optical properties)</a></li><li><a href="#14">Example ROfFx (multiple sets of optical properties)</a></li><li><a href="#15">Example ROfFx (multiple optical properties, varying mua as a function of wavelength, mus' as intralipid scatterer)</a></li><li><a href="#16">Example ROfFx (multiple optical properties, varying mua as a function of wavelength, mus' as mie scatterer)</a></li><li><a href="#17">Example ROfFx</a></li><li><a href="#18">Example ROfRho (multiple wavelengths, multiple rho)</a></li><li><a href="#19">Example ROfRho (inverse solution for chromophore concentrations for multiple wavelengths, single rho)</a></li><li><a href="#20">Example ROfRho for a two-layer tissue (multiple optical properties and rhos)</a></li><li><a href="#21">Example ROfFx for a two-layer tissue (multiple optical properties and fxs)</a></li><li><a href="#22">Example ROfRhoAndTime for a two-layer tissue (multiple optical properties and times)</a></li><li><a href="#23">Example ROfRhoAndFt for a two-layer tissue (multiple optical properties and fts)</a></li></ul></div><h2 id="2">Example ROfRhoAndFt</h2><p>Evaluate reflectance as a function of rho and temporal-frequency with one set of optical properites.</p><img vspace="5" hspace="5" src="vts_solver_demo_01.png" alt=""> <h2 id="3">Example ROfFxAndFt</h2><p>Evaluate reflectance as a function of spatial- and temporal- frequencies with one set of optical properites.</p><img vspace="5" hspace="5" src="vts_solver_demo_02.png" alt=""> <h2 id="4">Example FluenceOfRhoAndZ</h2><p>Evaluate fluence as a function of rho and z using optical properties from a list of chromophore absorbers with their concentrations and a power law scatterer for a range of wavelengths.</p><img vspace="5" hspace="5" src="vts_solver_demo_03.png" alt=""> <h2 id="5">Example FluenceOfRhoAndZAndFt</h2><p>Evaluate fluence as a function of rho and z using one set of optical properties and a distributed gaussian source SDA solver type.</p><img vspace="5" hspace="5" src="vts_solver_demo_04.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_05.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_06.png" alt=""> <h2 id="6">Example PHDOfRhoAndZ</h2><p>Evaluate Photon Hitting Density in cylindrical coordinates using one set of optical properties and a distributed gaussian source SDA solver type.</p><img vspace="5" hspace="5" src="vts_solver_demo_07.png" alt=""> <h2 id="7">Example FluenceOfRhoAndZTwoLayer</h2><p>Evaluate fluence in cylindrical coordinates for a two layer tissue with specified source-detector separation and top layer thickness using two sets of optical properties.</p><img vspace="5" hspace="5" src="vts_solver_demo_08.png" alt=""> <h2 id="8">Example PHDOfRhoAndZTwoLayer</h2><p>Evaluate Photon Hitting Density in cylindrical coordinates for a two layer tissue with specified source-detector separation and top layer thickness using two sets of optical properties.</p><img vspace="5" hspace="5" src="vts_solver_demo_09.png" alt=""> <h2 id="9">Example AbsorbedEnergyOfRhoAndZ</h2><p>Evaluate Absorbed Energy of rho and z using one set of optical properties and a point source SDA solver type.</p><img vspace="5" hspace="5" src="vts_solver_demo_10.png" alt=""> <h2 id="10">Example ROfRho</h2><p>Evaluate reflectance as a function of rho with three sets of optical properites.</p><img vspace="5" hspace="5" src="vts_solver_demo_11.png" alt=""> <h2 id="11">Example ROfRhoAndT</h2><p>Evaluate reflectance of rho and t at one s-d separation and two sets of optical properites.</p><img vspace="5" hspace="5" src="vts_solver_demo_12.png" alt=""> <h2 id="12">Example ROfFxAndT</h2><p>Evaluate reflectance as a function of spacial-frequency and t using one set of optical properites.</p><img vspace="5" hspace="5" src="vts_solver_demo_13.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_14.png" alt=""> <h2 id="13">Example ROfFx (single set of optical properties)</h2><p>Evaluate reflectance as a function of spacial-frequency with a single set of optical properties.</p><img vspace="5" hspace="5" src="vts_solver_demo_15.png" alt=""> <h2 id="14">Example ROfFx (multiple sets of optical properties)</h2><p>Evaluate reflectance as a function of spacial-frequency with multiple sets of optical properties, varying mua linearly.</p><img vspace="5" hspace="5" src="vts_solver_demo_16.png" alt=""> <h2 id="15">Example ROfFx (multiple optical properties, varying mua as a function of wavelength, mus' as intralipid scatterer)</h2><p>Evaluate reflectance as a function of spacial-frequency with multiple sets of optical properties, varying mua as a function of wavelength.</p><img vspace="5" hspace="5" src="vts_solver_demo_17.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_18.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_19.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_20.png" alt=""> <h2 id="16">Example ROfFx (multiple optical properties, varying mua as a function of wavelength, mus' as mie scatterer)</h2><p>Evaluate reflectance as a function of spacial-frequency with multiple sets of optical properties, varying mua as a function of wavelength.</p><img vspace="5" hspace="5" src="vts_solver_demo_21.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_22.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_23.png" alt=""> <img vspace="5" hspace="5" src="vts_solver_demo_24.png" alt=""> <h2 id="17">Example ROfFx</h2><p>Call planar reflectance with multiple sets of optical properties, varying the scattering prefactor as a function of wavelength.</p><img vspace="5" hspace="5" src="vts_solver_demo_25.png" alt=""> <h2 id="18">Example ROfRho (multiple wavelengths, multiple rho)</h2><p>Call reflectance varying the wavelength.</p><img vspace="5" hspace="5" src="vts_solver_demo_26.png" alt=""> <h2 id="19">Example ROfRho (inverse solution for chromophore concentrations for multiple wavelengths, single rho)</h2><pre class="codeoutput">
____________________________________________________________
   Diagnostic Information

Number of variables: 3

Functions 
Objective:                            lsqcurvefit/objective
Gradient:                             finite-differencing
 
Number of lower bound constraints:          0
Number of upper bound constraints:          0

Algorithm selected
   trust-region-reflective


____________________________________________________________
   End diagnostic information

Local minimum found.

Optimization completed because the size of the gradient is less than
the value of the optimality tolerance.

Meas =    [70.000 30.000 0.800]
IG =      [70.000 30.000 0.800] Chi2=6.425e-05
Conv =    [80.108 40.900 2.652] Chi2=8.310e-06
error =   [0.933 0.423 0.074]
</pre><img vspace="5" hspace="5" src="vts_solver_demo_27.png" alt=""> <h2 id="20">Example ROfRho for a two-layer tissue (multiple optical properties and rhos)</h2><img vspace="5" hspace="5" src="vts_solver_demo_28.png" alt=""> <h2 id="21">Example ROfFx for a two-layer tissue (multiple optical properties and fxs)</h2><img vspace="5" hspace="5" src="vts_solver_demo_29.png" alt=""> <h2 id="22">Example ROfRhoAndTime for a two-layer tissue (multiple optical properties and times)</h2><img vspace="5" hspace="5" src="vts_solver_demo_30.png" alt=""> <h2 id="23">Example ROfRhoAndFt for a two-layer tissue (multiple optical properties and fts)</h2><p>Evaluate reflectance as a function of rho and temporal-frequency with one set of optical properites.</p><img vspace="5" hspace="5" src="vts_solver_demo_31.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Solver Demos
% Script for demoing the use of the VTS solvers within Matlab, to view the
% source code open the *vts_solver_demo.m* script file.
%% 
clear vars
clc
dbstop if error;

startup();

%% Example ROfRhoAndFt
% Evaluate reflectance as a function of rho and temporal-frequency with one 
% set of optical properites.

op = [0.01 1.2 0.8 1.4];
rho = 10; % s-d separation, in mm
ft = 0:0.01:0.5; % range of temporal frequencies in GHz

% Solver type options: 'PointSourceSDA','DistributedGaussianSourceSDA',
% 'DistributedPointSourceSDA','MonteCarlo' (basic scaled),'Nurbs' (scaled
% with smoothing and adaptive binning)
VtsSolvers.SetSolverType('PointSourceSDA');

test = VtsSolvers.ROfRhoAndFt(op, rho, ft);

f = figure;
set(f, 'OuterPosition', [100, 50, 600, 800]);
subplot(3,1,1); plot(ft, [real(test) -imag(test)] );
title('Reflectance vs f_t'); 
ylabel('R(f_t)');
xlabel('f_t');
lgnd = legend('Real','Imaginary');
set(lgnd, 'FontSize', 12);
subplot(3,1,2); plot(ft, abs(test));
title('Reflectance amplitude vs f_t'); 
ylabel('R(f_t) Amplitude');
xlabel('f_t');
subplot(3,1,3); plot(ft, -angle(test));% or 'plot(ft, atan2(imag(test),real(test)))'
title('Reflectance phase vs f_t'); 
ylabel('R(f_t) Phase');
xlabel('f_t');
set(f,'Name','Reflectance as a function of Rho and Temporal-frequency');

%% Example ROfFxAndFt
% Evaluate reflectance as a function of spatial- and temporal- frequencies 
% with one set of optical properites.

op = [0.01 1 0.8 1.4];
fx = 0; % spatial frequency in 1/mm
ft = linspace(0,0.5,51); % range of temporal frequencies in GHz

test = VtsSolvers.ROfFxAndFt(op, fx, ft);

f = figure;
set(f, 'OuterPosition', [100, 50, 600, 800]);
subplot(3,1,1); plot(ft, [real(test) -imag(test)] );
title('Reflectance vs f_t'); 
ylabel('R(f_t)');
xlabel('f_t');
legend('Real','Imaginary');
subplot(3,1,2); plot(ft, abs(test));
title('Reflectance amplitude vs f_t'); 
ylabel('R(f_t) Amplitude');
xlabel('f_t');
subplot(3,1,3); plot(ft, -angle(test));% or 'plot(ft, atan2(imag(test),real(test)))'
title('Reflectance phase vs f_t'); 
ylabel('R(f_t) Phase');
xlabel('f_t');
set(f,'Name','Reflectance as a function of Spatial- and Temporal- frequencies');

%% Example FluenceOfRhoAndZ
% Evaluate fluence as a function of rho and z using optical properties from 
% a list of chromophore absorbers with their concentrations and a power law 
% scatterer for a range of wavelengths.

rhos = 0.1:0.1:10; % s-d separation, in mm
zs = 0.1:0.1:10; % z range in mm

wv = 450:0.5:1000;

% create a list of chromophore absorbers and their concentrations
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
absorbers.Concentrations =  [70,     30,   0.8  ];

% create a scatterer (PowerLaw, Intralipid, or Mie)
scatterer.Type = 'PowerLaw';
scatterer.A = 1.2;
scatterer.b = 1.42;

% % or 
% scatterer.Type = 'Intralipid';
% scatterer.vol_frac =  0.5;

% % or 
% scatterer.Type = 'Mie';
% scatterer.radius =  0.5;
% scatterer.n =       1.4;
% scatterer.nMedium = 1.0;
% scatterer.vol_frac = 0.5;

op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);

test = VtsSolvers.FluenceOfRhoAndZ(op, rhos, zs);

f = figure; imagesc(wv,zs,log(squeeze(test(:,1,:))));
ylabel('z [mm]');
xlabel('wavelength, \lambda [nm]');
title('Fluence of \lambda and z and \rho=0.1 mm'); 
set(f,'Name','Fluence as a function of Rho and z');


%% Example FluenceOfRhoAndZAndFt
% Evaluate fluence as a function of rho and z using one set of optical 
% properties and a distributed gaussian source SDA solver type.

op = [0.01 1 0.8 1.4];
rhos = linspace(0.1,19.9,100); % s-d separation, in mm
zs = linspace(0.1,19.9,100); % z range in mm
fts = linspace(0,1,2); % frequency range in GHz

VtsSolvers.SetSolverType('DistributedPointSourceSDA');
test = VtsSolvers.FluenceOfRhoAndZAndFt(op, rhos, zs, fts);

xs = [-fliplr(rhos(2:end)),rhos];
% xs = [-rhos(end:-1:2), rhos];

% f = figure; imagesc(log(test));
f = figure; imagesc(xs,zs,log([fliplr(squeeze(test(1,:,2:end))),squeeze(test(1,:,:))]));
axis image
title('Fluence of \rho and z and ft (ft=0GHz)'); 
xlabel('\rho [mm]')
ylabel('z [mm]')
set(f,'Name','Fluence of Rho and z and ft (ft=0GHz)');

f = figure; imagesc(xs,zs,log([fliplr(squeeze(test(2,:,2:end))),squeeze(test(2,:,:))]));
axis image
title('Fluence of \rho and z and ft (ft=1GHz)'); 
xlabel('\rho [mm]')
ylabel('z [mm]')
set(f,'Name','Fluence of Rho and z and ft (ft=1GHz)');

% 2nd figure to show modulation
modulation = squeeze(test(2,:,:)./test(1,:,:));
f = figure; imagesc(xs,zs,[fliplr(modulation(:,2:end)), modulation]);
axis image
title('Modulation of fluence (AC/DC) of \rho & z & ft (ft=1GHz)'); 
xlabel('\rho [mm]')
ylabel('z [mm]')
set(f,'Name','Modulation of fluence (AC/DC) of Rho and z and ft (ft=1GHz)');

%% Example PHDOfRhoAndZ
% Evaluate Photon Hitting Density in cylindrical coordinates
% using one set of optical properties and a distributed gaussian source SDA
% solver type.

op = [0.01 1 0.8 1.4];
rhos = linspace(0.1,19.9,100); % s-d separation, in mm
zs = linspace(0.1,19.9,100); % z range in mm

VtsSolvers.SetSolverType('DistributedGaussianSourceSDA');
test = VtsSolvers.PHDOfRhoAndZ(op, rhos, zs, 10);

f = figure; imagesc(rhos, zs, log(test));
axis image;
title('Photon Hitting Density of \rho and z'); 
xlabel('\rho [mm]')
ylabel('z [mm]')
set(f,'Name','PHD of Rho and z');

%% Example FluenceOfRhoAndZTwoLayer
% Evaluate fluence in cylindrical coordinates for a two
% layer tissue with specified source-detector separation and top layer thickness
% using two sets of optical properties.

op = [[1 1 0.8 1.4];[0.1 1 0.8 1.4]];
rhos = linspace(0.1,19.9,100); % s-d separation, in mm
zs = linspace(0.1,19.9,100); % z range in mm
topLayerThickness=5; % mm
test = VtsSolvers.FluenceOfRhoAndZTwoLayer(op, rhos, zs, topLayerThickness);

f = figure; imagesc(rhos, zs, log(test));
axis image;
title('Fluence of \rho and z - Two Layer'); 
xlabel('\rho [mm]');
ylabel('z [mm]');
set(f,'Name','Fluence of Rho and z - Two Layer');

%% Example PHDOfRhoAndZTwoLayer
% Evaluate Photon Hitting Density in cylindrical coordinates for a two
% layer tissue with specified source-detector separation and top layer thickness
% using two sets of optical properties.

op = [[0.01 1 0.8 1.4];[0.1 1 0.8 1.4]];
rhos = linspace(0.1,19.9,100); % s-d separation, in mm
zs = linspace(0.1,19.9,100); % z range in mm
sdsep = 10; % mm
topLayerThickness=5; % mm
test = VtsSolvers.PHDOfRhoAndZTwoLayer(op, rhos, zs, sdsep, topLayerThickness);

f = figure; imagesc(rhos, zs, log(test));
axis image;
title('Photon Hitting Density of \rho and z - Two Layer'); 
xlabel('\rho [mm]');
ylabel('z [mm]');
set(f,'Name','PHD of Rho and z - Two Layer');

%% Example AbsorbedEnergyOfRhoAndZ
% Evaluate Absorbed Energy of rho and z using one set of optical properties 
% and a point source SDA solver type.

op = [0.1 1 0.8 1.4];
rhos = linspace(0.1,19.9,100); % s-d separation, in mm
zs = linspace(0.1,19.9,100); % z range in mm

VtsSolvers.SetSolverType('PointSourceSDA');

xs = [-fliplr(rhos(2:end)),rhos];

test = VtsSolvers.AbsorbedEnergyOfRhoAndZ(op, rhos, zs);
% f = figure; imagesc(log(test));
f = figure; imagesc(xs, zs, log([fliplr(test),test]));
axis image;
title('Absorbed Energy of \rho and z'); 
xlabel('\rho [mm]');
ylabel('z [mm]');
set(f,'Name','Absorbed Energy of Rho and z');

%% Example ROfRho
% Evaluate reflectance as a function of rho with three sets
% of optical properites.

op = [[0.01 1 0.8 1.4]; [0.1 1 0.8 1.4]; [1 1 0.8 1.4]];
rho = 0.5:0.05:9.5; %s-d separation, in mm
%VtsSolvers.SolverType = 'DistributedPointSourceSDA';
test = VtsSolvers.ROfRho(op, rho);
f = figure; plot(rho, test);
set(f,'Name','Reflectance vs Rho for various optical properties');
% create the legend with just the mua value from the optical properties
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(op(:,1), '\mu_a: ', 'mm^-^1', options);
title('Reflectance vs \rho for various optical properties'); 
ylabel('R(\rho)');
xlabel('\rho');

%% Example ROfRhoAndT
% Evaluate reflectance of rho and t at one s-d separation and 
% two sets of optical properites.

op = [[0.1 1.2 0.8 1.4]; [0.2 1.2 0.8 1.4]];
rho = 10; %s-d separation, in mm
t = 0:0.001:0.5; % range of times in ns
test0 = VtsSolvers.ROfRhoAndT(op, rho, t);
f = figure; plot(t, squeeze(test0));
set(f,'Name','Reflectance of Rho vs time for various optical properties');
% create the legend with just the mua value from the optical properties
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(op(:,1), '\mu_a: ', 'mm^-^1', options);
title({'Reflectance of \rho vs time for various optical properties'; ' '}); 
ylabel('R(t)');
xlabel('Time, t [ns]');

%% Example ROfFxAndT 
% Evaluate reflectance as a function of spacial-frequency and t using one 
% set of optical properites.

op = [0.1 1 0.8 1.4];
fx = linspace(0,0.5,11); % range of spatial frequencies in 1/mm
t = linspace(0,0.05,501); % range of times in ns
test = VtsSolvers.ROfFxAndT(op, fx, t);
f = figure; plot(t,squeeze(test(:,:,:)));
set(f,'Name','R of fx and t (Reflectance vs time)');
set(f, 'OuterPosition', [100, 50, 700, 700]);
title('Reflectance vs time at various spatial frequencies'); 
ylabel('R(f_x, t)');
xlabel('Time, t [ns]');
%Create the legend dynamically
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(fx, 'f_x = ', 'mm^-^1', options);
t = [0.01 0.05];
test = VtsSolvers.ROfFxAndT(op, fx, t);
f = figure; plot(fx,squeeze(test));
set(f,'Name','R of fx and t (Reflectance vs spatial frequency)');
title('Reflectance vs spatial frequency at 0.01 and 0.05 ns'); 
ylabel('R(f_x, t)');
xlabel('Spatial frequency, f_x [mm^-^1]');
%Create the legend dynamically - can be replaced by PlotHelper.CreateLegend(t, 't = ', 'ns', '');
l2 = cell(1,length(t)); %create a 1xlength(t) cell array to hold the string values
for i=1:length(t)
    str = sprintf('t = %2.2fns', t(i));
    l2{1,i} = str;
end
legend(l2, 'FontSize', 12);

%% Example ROfFx (single set of optical properties)
% Evaluate reflectance as a function of spacial-frequency with a single set 
% of optical properties.

fx = 0:0.001:0.2; % range of spatial frequencies in 1/mm
op = [0.1 1.2 0.8 1.4];
test1 = VtsSolvers.ROfFx(op, fx);
f = figure; plot(fx, test1);
set(f,'Name','R of fx');
title('Reflectance vs spatial frequency'); 
ylabel('R(f_x)');
xlabel('Spatial frequency, f_x [mm^-^1]');

%% Example ROfFx (multiple sets of optical properties)
% Evaluate reflectance as a function of spacial-frequency
% with multiple sets of optical properties, varying mua linearly.

fx = 0:0.001:0.2; % range of spatial frequencies in 1/mm
mua = (0:0.01:0.1)';
op = repmat([0 1.2 0.8 1.4],[length(mua) 1]);
op(:,1) = mua;

test2 = VtsSolvers.ROfFx(op, fx);
f = figure; plot(fx, test2);
set(f, 'Name', 'R of fx (varying mua linearly)');
set(f, 'OuterPosition', [100, 50, 700, 700]);
title('Reflectance vs spatial frequency'); 
options = [{'Location', 'NorthEast'}; {'FontSize', 12}; {'Box', 'on'}];
PlotHelper.CreateLegend(op(:,1), '\mu_a: ', 'mm^-^1', options);
ylabel('R(f_x)');
xlabel('Spatial frequency, f_x [mm^-^1]');


%% Example ROfFx (multiple optical properties, varying mua as a function of wavelength, mus' as intralipid scatterer)
% Evaluate reflectance as a function of spacial-frequency with multiple 
% sets of optical properties, varying mua as a function of wavelength.

fx = 0:0.05:0.2; % range of spatial frequencies in 1/mm
wv = 450:0.5:1000;
nwv = length(wv);

% create a list of chromophore absorbers and their concentrations
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
absorbers.Concentrations =  [70,     30,   0.8  ];

% create a scatterer (PowerLaw, Intralipid, or Mie)
% scatterer.Type = 'PowerLaw';
% scatterer.A = 1.2;
% scatterer.b = 1.42;

% % or 
scatterer.Type = 'Intralipid';
scatterer.vol_frac =  0.5;

% % or 
% scatterer.Type = 'Mie';
% scatterer.radius =  0.5;
% scatterer.n =       1.4;
% scatterer.nMedium = 1.0;
% scatterer.vol_frac = 0.5;

op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);

% plot the absorption spectrum
f = figure; plot(wv, op(:,1));
set(f, 'Name', 'R of fx (plot absorption spectrum)');
title('Absorption vs wavelength');
ylabel('\mu_a(\lambda)');
xlabel('Wavelength, \lambda [nm]');

% plot the log of the absorption spectrum
f = figure; semilogy(wv, op(:,1));
set(f, 'Name', 'R of fx (plot log of the absorption spectrum)');
title('log(Absorption) vs wavelength'); 
ylabel('\mu_a(\lambda)');
xlabel('Wavelength, \lambda [nm]');

% plot the scattering spectrum
f = figure; plot(wv, op(:,2));
set(f, 'Name', 'R of fx (plot scattering spectrum)');
title('Reduced scattering vs wavelength'); 
ylabel('\mu_s^''(\lambda)');
xlabel('Wavelength, \lambda [nm]');

% calculate and plot the resulting reflectance spectrum at each frequency
test3 = VtsSolvers.ROfFx(op, fx);
f = figure; plot(wv, test3);
set(f, 'Name', 'R of fx (plot resulting reflectance spectrum at each frequency)');
title('SFD Reflectance vs wavelength'); 
ylabel('R(\lambda)');
xlabel('Wavelength, \lambda [nm]');
options = [{'Location', 'NorthWest'}; {'FontSize', 12}; {'Box', 'on'}];
PlotHelper.CreateLegend(fx, 'f_x = ', 'mm^-^1', options);
%% Example ROfFx (multiple optical properties, varying mua as a function of wavelength, mus' as mie scatterer)
% Evaluate reflectance as a function of spacial-frequency with multiple 
% sets of optical properties, varying mua as a function of wavelength.

fx = 0:0.05:0.2; % range of spatial frequencies in 1/mm
wv = 450:0.5:1000;
nwv = length(wv);

% create a list of chromophore absorbers and their concentrations
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
absorbers.Concentrations =  [70,     30,   0.8  ];

% create a scatterer (PowerLaw, Intralipid, or Mie)
% scatterer.Type = 'PowerLaw';
% scatterer.A = 1.2;
% scatterer.b = 1.42;

% % or 
% scatterer.Type = 'Intralipid';
% scatterer.vol_frac =  0.5;

% % or 
scatterer.Type = 'Mie';
scatterer.radius =  0.5;
scatterer.n =       1.4;
scatterer.nMedium = 1.0;
scatterer.vol_frac = 0.5;

op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);

% plot the absorption spectrum
f = figure; plot(wv, op(:,1));
set(f, 'Name', 'R of fx (plot absorption spectrum)');
title('Absorption vs wavelength');
ylabel('\mu_a(\lambda)');
xlabel('Wavelength, \lambda [nm]');

% plot the log of the absorption spectrum
f = figure; semilogy(wv, op(:,1));
set(f, 'Name', 'R of fx (plot log of the absorption spectrum)');
title('log(Absorption) vs wavelength'); 
ylabel('\mu_a(\lambda)');
xlabel('Wavelength, \lambda [nm]');

% plot the scattering spectrum
f = figure; plot(wv, op(:,2));
set(f, 'Name', 'R of fx (plot scattering spectrum)');
title('Reduced scattering vs wavelength'); 
ylabel('\mu_s^''(\lambda)');
xlabel('Wavelength, \lambda [nm]');

% calculate and plot the resulting reflectance spectrum at each frequency
test3 = VtsSolvers.ROfFx(op, fx);
f = figure; plot(wv, test3);
set(f, 'Name', 'R of fx (plot resulting reflectance spectrum at each frequency)');
title('SFD Reflectance vs wavelength'); 
ylabel('R(\lambda)');
xlabel('Wavelength, \lambda [nm]');
options = [{'Location', 'NorthWest'}; {'FontSize', 12}; {'Box', 'on'}];
PlotHelper.CreateLegend(fx, 'f_x = ', 'mm^-^1', options);

%% Example ROfFx
% Call planar reflectance with multiple sets of optical
% properties, varying the scattering prefactor as a function of wavelength.

fx = 0; % spatial frequency in 1/mm
wv = 400:0.5:1000;

% create a list of chromophore absorbers and their concentrations
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
absorbers.Concentrations =  [70,     30,   0.8  ];

% create a scatterer (PowerLaw, Intralipid, or Mie)
scatterer.Type = 'PowerLaw';
scatterer.A = 1.0;
scatterer.b = 1.42;

A = 0.5:0.25:2.5;
test4 = zeros([length(A) length(wv)]);
for i=1:length(A)
    scatterer.A = A(i);
    op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);
    test4(i,:) = VtsSolvers.ROfFx(op, fx);
end

f = figure; plot(wv, test4');
set(f, 'Name', 'Planar reflectance');
set(f, 'OuterPosition', [100, 50, 800, 800]);
title('SFD Reflectance vs wavelength'); 
ylabel('R(\lambda)');
xlabel('Wavelength, \lambda [nm]');
options = [{'Location', 'NorthWest'}; {'FontSize', 12}; {'Box', 'on'}];
PlotHelper.CreateLegend(A, '\mu_s''(1000nm) = ', 'mm^-^1', options);

%% Example ROfRho (multiple wavelengths, multiple rho)
% Call reflectance varying the wavelength.

VtsSolvers.SetSolverType('PointSourceSDA');
rho = 0.2:0.2:1;  % source-detector separation in mm
wv = 400:0.5:1000;

% create a list of chromophore absorbers and their concentrations
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
absorbers.Concentrations =  [70,     30,   0.8  ];

% create a scatterer (PowerLaw, Intralipid, or Mie)
scatterer.Type = 'PowerLaw';
scatterer.A = 1.2;
scatterer.b = 1.42;

op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);
test = zeros([length(rho) length(wv)]);
for i=1:length(rho)
    test(i,:) = VtsSolvers.ROfRho(op, rho(i));
end

f = figure; plot(wv, test');
set(f, 'Name', 'SDA Reflectance vs wavelength');
set(f, 'OuterPosition', [100, 50, 800, 800]);
title('SDA Reflectance vs wavelength'); 
ylabel('R(\lambda)');
xlabel('Wavelength, \lambda [nm]');
options = [{'Location', 'NorthEast'}; {'FontSize', 12}; {'Box', 'on'}];
PlotHelper.CreateLegend(rho,'\rho = ', 'mm',options);
%% Example ROfRho (inverse solution for chromophore concentrations for multiple wavelengths, single rho)

rho = 1;  % source-detector separation in mm
wv = 400:50:1000;

% create a list of chromophore absorbers and their concentrations
% these values are the EXACT solution
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
measConc =                  [70,     30,   0.8  ];
absorbers.Concentrations =  [measConc(1), measConc(2), measConc(3)];

% create a scatterer (PowerLaw, Intralipid, or Mie)
scatterer.Type = 'PowerLaw';
scatterer.A = 1.2;
scatterer.b = 1.42;

op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);

% create simulated measured data at EXACT data using MC Nurbs solution
VtsSolvers.SetSolverType('Nurbs');
measData = VtsSolvers.ROfRho(op, rho);

% Set up options for lsqcurvefit/fminsearch function

% use unconstrained optimization, constrained option lb=[0 0]; ub=[inf inf];
lb=[]; ub=[];
% specify initial guess 
conc0 = [ 70,    30,   0.8  ];
% run inverse solver using SDAPointSource forward model
if(exist('lsqcurvefit','file'))
    options = optimset('diagnostics','on','largescale','on');
    recoveredConc = lsqcurvefit('sda_F',conc0,wv,measData,lb,ub,options,rho,scatterer);
else
    options = [];
    recoveredConc = fminsearch('sda_Chi2',conc0,options,wv,rho,scatterer,measData);
end
    % determine forward solver solution at recovered concentrations
VtsSolvers.SetSolverType('PointSourceSDA');
absorbers.Concentrations =  [recoveredConc(1), recoveredConc(2), recoveredConc(3) ];
op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);
recovered = VtsSolvers.ROfRho(op, rho);
% determine forward solver solution at initial guess
absorbers.Concentrations =  [conc0(1), conc0(2), conc0(3)];
op = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);
initialGuess = VtsSolvers.ROfRho(op, rho);

f = figure; plot(wv, measData,'ro',...
    wv, initialGuess,'go',...
    wv, recovered,'b:');
xlabel('Wavelength, \lambda [nm]');
ylabel('R(\lambda)');
legend('Meas','IG','Converged');
set(f, 'Name', 'ROfRho (inverse solution for chromophore concentrations, multiple wavelengths, single Rho)');
title('ROfRho (inverse solution for chromophore concentrations, multiple wavelengths, single \rho)'); 
set(f, 'OuterPosition', [100, 50, 960, 850]); 
options = [{'Location', 'NorthEast'}; {'FontSize', 12}; {'Box', 'on'}];
disp(sprintf('Meas =    [%5.3f %5.3f %5.3f]',measConc(1),measConc(2),measConc(3)));
disp(sprintf('IG =      [%5.3f %5.3f %5.3f] Chi2=%5.3e',conc0(1),conc0(2),conc0(3),...
    (measData-initialGuess)*(measData-initialGuess)'));
disp(sprintf('Conv =    [%5.3f %5.3f %5.3f] Chi2=%5.3e',recoveredConc(1),recoveredConc(2),recoveredConc(3),...
    (measData-recovered)*(measData-recovered)'));
disp(sprintf('error =   [%5.3f %5.3f %5.3f]',abs(measData(1)-recovered(1))/measData(1),...
    abs(measData(2)-recovered(2))/measData(2),abs(measData(3)-recovered(3))/measData(3)));
%% Example ROfRho for a two-layer tissue (multiple optical properties and rhos)
clear op
topLayerThickness = 2;  % units: mm

opsA = [0.01 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 1
opsB = [0.02 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 2
opsC = [0.03 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 3
op(1,:,:) = [opsA];
op(2,:,:) = [opsB];
op(3,:,:) = [opsC];

rho = 0.5:0.05:9.5; %s-d separation, in mm
test = VtsSolvers.ROfRhoTwoLayer(op, topLayerThickness, rho);
f = figure; semilogy(rho, test);
set(f,'Name','2-Layer Reflectance vs Rho for various top Layer Optical Properties');
% create the legend with just the mua value from the top layer optical properties
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(op(:,1), 'top \mu_a: ', 'mm^-^1', options);
title('2-Layer Reflectance vs \rho for various top Layer OPs'); 
ylabel('R(\rho)');
xlabel('\rho');
%% Example ROfFx for a two-layer tissue (multiple optical properties and fxs)
clear op
topLayerThickness = 2;  % units: mm

opsA = [0.01 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 1
opsB = [0.02 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 2
opsC = [0.03 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 3
op(1,:,:) = [opsA];
op(2,:,:) = [opsB];
op(3,:,:) = [opsC];

fx = 0:0.01:0.5; % range of spatial frequencies in 1/mm
test = VtsSolvers.ROfFxTwoLayer(op, topLayerThickness, fx);
f = figure; semilogy(fx, test);
set(f,'Name','2-Layer Reflectance vs Fx for various top Layer Optical Properties');
% create the legend with just the mua value from the top layer optical properties
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(op(:,1), 'top \mu_a: ', 'mm^-^1', options);
title('2-Layer Reflectance vs fx for various top Layer OPs'); 
ylabel('R(fx)');
xlabel('fx');
%% Example ROfRhoAndTime for a two-layer tissue (multiple optical properties and times)
clear op
topLayerThickness = 2;  % units: mm
% 
% opsA = [0.01 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 1
% opsB = [0.02 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 2
% opsC = [0.03 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 3
% op(1,:,:) = [opsA];
% op(2,:,:) = [opsB];
% op(3,:,:) = [opsC];

wv = 650:100:850;

% create a list of chromophore absorbers and their concentrations
absorbers.Names =           {'HbO2', 'Hb', 'H2O'};
absorbers.Concentrations =  [70,     30,   0.8  ];

% create a scatterer (PowerLaw, Intralipid, or Mie)
scatterer.Type = 'PowerLaw';
scatterer.A = 1.2;
scatterer.b = 1.42;

opBottomLayer = VtsSpectroscopy.GetOP(absorbers, scatterer, wv);
% get OPs at first wavelength and perturb top layer mua by factor 1.1
opsA = [opBottomLayer(1,1) opBottomLayer(1,2) opBottomLayer(1,3) opBottomLayer(1,4);
      1.1*opBottomLayer(1,1) opBottomLayer(1,2) opBottomLayer(1,3) opBottomLayer(1,4)];
% get OPs at first wavelength and perturb top layer mua
opsB = [opBottomLayer(2,1) opBottomLayer(2,2) opBottomLayer(2,3) opBottomLayer(2,4);
      1.1*opBottomLayer(2,1) opBottomLayer(2,2) opBottomLayer(2,3) opBottomLayer(2,4)];
% get OPs at first wavelength and perturb top layer mua
opsC = [opBottomLayer(3,1) opBottomLayer(3,2) opBottomLayer(3,3) opBottomLayer(3,4);
      1.1*opBottomLayer(3,1) opBottomLayer(3,2) opBottomLayer(3,3) opBottomLayer(3,4)];
op(1,:,:) = [opsA];
op(2,:,:) = [opsB];
op(3,:,:) = [opsC];
  
rho = 10; %s-d separation, in mm
t = 0:0.001:0.5; % range of times in ns
test = VtsSolvers.ROfRhoAndTimeTwoLayer(op, topLayerThickness, rho, t);
f = figure; plot(t, squeeze(test));
set(f,'Name','2-Layer Reflectance vs time for various top Layer Optical Properties');
% create the legend with just the mua value from the optical properties
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
%PlotHelper.CreateLegend(op(:,1), 'top \mu_a: ', 'mm^-^1', options);
PlotHelper.CreateLegend(wv(1,:), '', 'nm', options);
title('2-Layer Reflectance vs time for various top Layer OPs'); 
ylabel('R(t)');
xlabel('Time, t [ns]');

%% Example ROfRhoAndFt for a two-layer tissue (multiple optical properties and fts)
% Evaluate reflectance as a function of rho and temporal-frequency with one 
% set of optical properites.
clear op
topLayerThickness = 2;  % units: mm

opsA = [0.01 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 1
opsB = [0.02 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 2
opsC = [0.03 1 0.8 1.4; 0.01 1 0.8 1.4]; % top/bottom layer OPs case 3
op(1,:,:) = [opsA];
op(2,:,:) = [opsB];
op(3,:,:) = [opsC];

rho = 10; % s-d separation, in mm
ft = 0:0.01:0.5; % range of temporal frequencies in GHz

test = VtsSolvers.ROfRhoAndFtTwoLayer(op, topLayerThickness, rho, ft);

f = figure;
set(f, 'OuterPosition', [100, 50, 600, 800]);
subplot(3,1,1); 
plot(ft, [real(squeeze(test(1,:,:))) -imag(squeeze(test(1,:,:)))],...
     ft, [real(squeeze(test(2,:,:))) -imag(squeeze(test(2,:,:)))],...
     ft, [real(squeeze(test(3,:,:))) -imag(squeeze(test(3,:,:)))]);
title('2-Layer Reflectance vs f_t'); 
ylabel('R(f_t)');
xlabel('f_t');
lgnd = legend('Real','Imaginary');
set(lgnd,'FontSize',12);
subplot(3,1,2); 
plot(ft, abs(squeeze(test(1,:,:))),...
     ft, abs(squeeze(test(2,:,:))),...
     ft, abs(squeeze(test(3,:,:))));
title('2-Layer Reflectance amplitude vs f_t'); 
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(op(:,1), 'top \mu_a: ', 'mm^-^1', options);
ylabel('R(f_t) Amplitude');
xlabel('f_t');
subplot(3,1,3); 
plot(ft, -angle(squeeze(test(1,:,:))),...
     ft, -angle(squeeze(test(2,:,:))),...
     ft, -angle(squeeze(test(3,:,:))));
title('2-Layer Reflectance phase vs f_t'); 
ylabel('R(f_t) Phase');
xlabel('f_t');
set(f,'Name','Frequency-domain reflectance');
options = [{'FontSize', 12}; {'Location', 'NorthEast'}];
PlotHelper.CreateLegend(op(:,1), 'top \mu_a: ', 'mm^-^1', options);
##### SOURCE END #####
--></body></html>